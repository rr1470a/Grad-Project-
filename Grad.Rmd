---
title: "Grad Proj"
author: "Huma Meer"
date: '2022-07-23'
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(dplyr)
library(ggplot2)
library(censusapi)

```

```{r}
# Add key to .Renviron
Sys.setenv(CENSUS_KEY="2af9f600486ef6ad342ed1e8a978c0956a70a52c")
# Reload .Renviron
readRenviron("~/.Renviron")
# Check to see that the expected key is output in your R console
Sys.getenv("CENSUS_KEY")
```


```
Calculating the Average Annual Payroll Per Employeer by Industry for the DMV area only


cbp_dmv <- getCensus( name = "cbp" ,
           vintage = 2020,
           key = Sys.getenv("CENSUS_KEY"),
           vars = c("NAME","NAICS2017","NAICS2017_LABEL","PAYANN","EMP"),
          region = "state:11,24,51")

cbp_AP_dmv <- cbp_dmv %>% 
  as_tibble() %>% 
  filter(NAICS2017 %in% c("11","21","22","23","31","42","44","48","51","52","53","54","55","56","61","62","71","72", "81","99")) %>% 
  group_by(NAICS2017) %>% 
  mutate(sumpayann= sum(PAYANN)) %>% 
  mutate(sumemp=sum(EMP)) %>% 
  mutate(annual_payroll_per_employee= sumpayann/sumemp) %>% 
  select(NAICS2017_LABEL,annual_payroll_per_employee)

cbp_AP_dmv <- cbp_AP_dmv[!duplicated(cbp_AP_dmv), ]
view(cbp_AP_dmv)

```

Creating a plot for dmv only
```{r}
dmv_api_plot <- data.frame(cbp10_AP_dmv)%>% 
  ggplot(aes(y =reorder(NAICS2017_relabel, annual_payroll_per_employee), 
             x = annual_payroll_per_employee)) +
  geom_col()+
  geom_text(aes(label=round(annual_payroll_per_employee, digits = 0)), vjust=-0.1, size=3.5) +
  xlab("Annual Payroll per Employee ($1,000)") +
  ggtitle("Top 10 Paying Industries in the DMV Area") +
  theme_minimal()+
  theme(axis.title.y = element_blank())
dmv_api_plot
  



```
FOR US

```{r}

cbp_US <- getCensus( name = "cbp" ,
           vintage = 2020,
           key = Sys.getenv("CENSUS_KEY"),
           vars = c("NAME","NAICS2017","NAICS2017_LABEL","PAYANN","EMP"),
          region = "us")

cbp_AP_US <- cbp_US %>% 
  as_tibble() %>% 
  filter(NAICS2017 %in% c("11","21","22","23","31","42","44","48","51","52","53","54","55","56","61","62","71","72", "81","99")) %>% 
  group_by(NAICS2017) %>% 
  mutate(sumpayann= sum(PAYANN)) %>% 
  mutate(sumemp=sum(EMP)) %>% 
  mutate(annual_payroll_per_employee= sumpayann/sumemp) %>% 
  select(NAICS2017_LABEL,annual_payroll_per_employee)

cbp_AP_US <- cbp_AP_US[!duplicated(cbp_AP_US), ]
view(cbp_AP_US)
  

US_AP_plot <- data.frame(cbp_AP_US)%>% 
  slice_head(n=10) %>% 
  ggplot(aes(y =reorder(NAICS2017_LABEL, annual_payroll_per_employee), x = annual_payroll_per_employee)) +
  geom_col()+
  geom_text(aes(label=round(annual_payroll_per_employee, digits = 0)),
            nudge_x = 2.5, nudge_y = -0.1,
            vjust = 0) +
  xlab("Annual Payroll per Employee ($1,000)") +
  ggtitle("Top 10 Paying Industries in the USA") +
  geom_col(aes(y =reorder(NAICS2017_LABEL, annual_payroll_per_employee), x = annual_payroll_per_employee))+
  theme_minimal()+
  theme(axis.title.y = element_blank())
US_AP_plot


#Summary Plot for largest employer in DMV area by Industry
cbp_EMP_dmv <- cbp_dmv %>% 
  as_tibble() %>% 
  filter(NAICS2017 %in% c("11","21","22","23","31","42","44","48","51","52","53","54","55","56","61","62","71","72", "81","99")) %>% 
  group_by(NAICS2017) %>% 
  mutate(sumemp=sum(EMP)) %>% 
  select(NAICS2017, NAICS2017_LABEL, sumemp) %>% 
  arrange(desc(sumemp)) 
cbp_EMP_dmv <- cbp_EMP_dmv[!duplicated(cbp_EMP_dmv), ]
cbp_EMP_dmv2 <- cbp_EMP_dmv[1:10, ]
cbp_EMP_dmv2$industry <- c("Health care and social assistance",
                        "Professional, scientific, and technical services",
                        "Accommodation and food services",
                        "Waste Management", "Construction", 
                        "Other services (except public administration)",
                        "Finance and insurance", 
                        "Educational Services",
                        "Wholesale trade", "Information")
view(cbp_EMP_dmv2)

DMV_EMP_plot <- data.frame(cbp_EMP_dmv2)%>% 
  ggplot(aes(y =reorder(industry, sumemp), x = sumemp)) +
  geom_col()+
  geom_text(aes(label= sumemp), nudge_x = 50000) +
  xlab("Total Employees") +
  ggtitle("Top 10 Employers in the DMV Area by Industry") +
  theme_minimal()+
  theme(axis.title.y = element_blank())
DMV_EMP_plot


#Summary Plot for  largest employer in USA by Industry
cbp_EMP_US <- cbp_US %>% 
  as_tibble() %>% 
  filter(NAICS2017 %in% c("11","21","22","23","31","42","44","48","51","52","53","54","55","56","61","62","71","72", "81","99")) %>% 
  group_by(NAICS2017) %>% 
  mutate(sumemp=sum(EMP)) %>% 
  select(NAICS2017, NAICS2017_LABEL, sumemp) %>% 
  arrange(desc(sumemp))
cbp_EMP_US <- cbp_EMP_US[!duplicated(cbp_EMP_US), ]
view(cbp_EMP_US)

cbp_EMP_US2 <- cbp_EMP_US[1:10, ]
cbp_EMP_US2$industry <- c("Health care and social assistance",
                           "Accommodation and food services",
                           "Waste Management",
                           "Professional, scientific, and technical services", 
                           "Construction", 
                           "Finance and insurance",
                           "Wholesale trade", 
                           "Other services (except public administration)",
                           "Educational services", "Information")

US_EMP_plot <- data.frame(cbp_EMP_US2)%>% 
  ggplot(aes(y =reorder(industry, sumemp), x = sumemp)) +
  geom_col()+
  geom_text(aes(label= sumemp), nudge_x = 1500000) +
  xlab("Total Employees") +
  ggtitle("Top 10 Employers in the US by Industry") +
  theme_minimal()+
  theme(axis.title.y = element_blank())
US_EMP_plot
